
<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="../dist/batch-address-auto-complete.min.css">
<script src="../dist/batch-address-auto-complete.min.js"></script>
<script src="environment.js"></script>
<style>
  .highlight {
    font-size: 24px;
    color: red;
  }
</style>
<script>
	var selectedAddress = {}
  function initialize() {
      // Custom Autocomplete of Batch Service
      batchAutocomplete(document.getElementById("batchAddressAutoComplete"), env.domainServer, env.apiKey);

      // Add an event listener to get value
      document.addEventListener("batch-address-auto-complete", function(e) {
         console.log('Selected item: ', e.detail);
         if (e.detail) {
             selectedAddress = {
                 address: e.detail.name,
                 city: e.detail.city,
                 state: e.detail.state,
                 zip: e.detail.zip,
                 latitude: e.detail.latitude,
                 longitude: e.detail.longitude
             };
             document.getElementById('getAddress').textContent = 'Selected address: ' + e.detail.name;
             console.log(selectedAddress)
         } else {
             console.log("No address detail found");
         }
      });

      // Add an event listener to handle error
      document.addEventListener("batch-auto-complete-error", function (e) {
         console.log("Error while searching: ", e.detail);
      });
  }

  function calculateScore() {
    if (!selectedAddress.address) {
      alert('Please select an address first.');
      return;
    }
    fetchGeoId();
  }

  function fetchGeoId() {
    fetch(`http://localhost:5000/api/get_geo_id?address=${encodeURIComponent(JSON.stringify(selectedAddress))}`)
      .then(response => response.json())
      .then(data => {
        const geoId = data.geo_id;
        Promise.all([
          fetch(`http://localhost:5000/api/crime_score?geo_id=${geoId}`).then(res => res.json()),
          fetch(`http://localhost:5000/api/school_score?geo_id=${geoId}`).then(res => res.json()),
          fetch(`http://localhost:5000/api/nsfr_scores?latitude=${selectedAddress.latitude}&longitude=${selectedAddress.longitude}`).then(res => res.json()),
          fetch(`http://localhost:5000/api/rsfr_scores?latitude=${selectedAddress.latitude}&longitude=${selectedAddress.longitude}`).then(res => res.json()),
          fetch(`http://localhost:5000/api/cap_rate?address=${encodeURIComponent(JSON.stringify(selectedAddress))}`).then(res => res.json())
        ]).then(results => {
          const [crimeData, schoolData, nsfrData, rsfrData, capRateData] = results;
          selectedAddress.crime_rate = crimeData.crime_rate;
          selectedAddress.school_rate = schoolData.school_rate;
          selectedAddress.nsfr = nsfrData.nsfr;
          selectedAddress.rsfr = sfrData.rsfr;
          selectedAddress.cap_rate = capRateData.cap_rate;
          fetchInvestibilityScore();
        });
      });
  }

  function fetchInvestibilityScore() {
    fetch('http://localhost:5000/api/investibility_score', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(selectedAddress)
    })
    .then(response => response.json())
    .then(data => {
      displayInvestibilityScore(data.investibility_score);
    });
  }

  function displayInvestibilityScore(score) {
    document.getElementById('dataDisplay').textContent = `Investibility Score: ${score}`;
  }


</script>
</head>
<body onload="initialize()">

  <h2>Kurbli</h2>
  <p>Start typing to select address:</p>
  <div class="batch-loading">
    <input class="batch-autocomplete" id="batchAddressAutoComplete" notFoundText="No results found" showNotFound=true
       displayData="name" type="text" take="5" debounce='700' placeholder="Enter your address">
    <div id="batch-loader"></div>
    <div id="batchNoDataFound"></div>
  </div>
  <button onclick="calculateScore()">Calculate Score</button>
  <div>
     <p style="font-weight: 900; color: blue;" id='getAddress'></p>
	   <div id='dataDisplay'></div>

  </div>
</body>
</html>
